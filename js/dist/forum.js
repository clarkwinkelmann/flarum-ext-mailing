(()=>{var n={n:t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},d:(t,e)=>{for(var a in e)n.o(e,a)&&!n.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},o:(n,t)=>Object.prototype.hasOwnProperty.call(n,t),r:n=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})}},t={};(()=>{"use strict";n.r(t),n.d(t,{extend:()=>N});const e=flarum.core.compat["forum/app"];var a=n.n(e);const i=flarum.core.compat["common/extend"],r=flarum.core.compat["common/components/Button"];var o=n.n(r);const l=flarum.core.compat["forum/utils/UserControls"];var s=n.n(l);const c=flarum.core.compat["forum/components/SessionDropdown"];var u=n.n(c);function f(n,t){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,t){return n.__proto__=t,n},f(n,t)}function p(n,t){n.prototype=Object.create(t.prototype),n.prototype.constructor=n,f(n,t)}const d=flarum.core.compat["common/components/Modal"];var h=n.n(d);const g=flarum.core.compat["common/components/LoadingIndicator"];var k=n.n(g);const w=flarum.core.compat["common/models/Group"];var b=n.n(w);const v=flarum.core.compat["common/helpers/username"];var y=n.n(v);const _=flarum.core.compat["common/helpers/icon"];var R=n.n(_);const M=flarum.core.compat["common/utils/KeyboardNavigatable"];var x=n.n(M),C=function(n){function t(){return n.apply(this,arguments)||this}p(t,n);var e=t.prototype;return e.className=function(){return"KilowhatMailingSentModal Modal--small"},e.title=function(){return a().translator.trans("clarkwinkelmann-mailing.forum.modal_sent.title_text")},e.content=function(){return[m(".MailingShipping",R()("fas fa-shipping-fast")),m(".Modal-body",[m("h1",a().translator.trans("clarkwinkelmann-mailing.forum.modal_sent.on_its_way",{recipientsCount:this.attrs.recipientsCount}))])]},t}(h());const S=flarum.core.compat["common/Model"];var I=n.n(S),j=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];return(t=n.call.apply(n,[this].concat(a))||this).email=I().attribute("email"),t}return p(t,n),t}(I()),T=/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,O=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];return(t=n.call.apply(n,[this].concat(a))||this).sending=!1,t.recipients=[],t.subject="",t.messageText="",t.searchIndex=0,t.navigator=new(x()),t.filter="",t.focused=!1,t.loadingResults=!1,t.searchResults=[],t.searchTimeout=-1,t}p(t,n);var e=t.prototype;return e.oninit=function(t){var e=this;if(n.prototype.oninit.call(this,t),this.recipients=[],this.attrs.user&&this.recipients.push(this.attrs.user),this.attrs.forAll){var i=a().store.getById("groups",b().MEMBER_ID);this.recipients.push(i)}this.navigator.when((function(n){return"Tab"!==n.key||!!e.filter})).onUp((function(){e.searchIndex>0&&(e.searchIndex--,m.redraw())})).onDown((function(){e.searchIndex<e.searchResults.length-1&&(e.searchIndex++,m.redraw())})).onSelect((function(){e.selectResult(e.searchResults[e.searchIndex])})).onRemove((function(){e.recipients.pop()}))},e.className=function(){return"KilowhatMailingModal Modal--large"},e.title=function(){return a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.title_text")},e.onready=function(){this.$("form").find(".js-focus-on-load").first().focus().select()},e.recipientLabel=function(n){switch(n.data.type){case"users":return m(".RecipientLabel",y()(n));case"groups":var t=n;return m(".RecipientLabel",t.color()?{className:"colored",style:{backgroundColor:t.color()}}:{},[t.icon()?[R()(t.icon())," "]:null,t.namePlural()]);case"clarkwinkelmann-mailing-emails":return m(".RecipientLabel",n.email())}return"[unknown]"},e.searchResultKind=function(n){switch(n.data.type){case"users":return a().translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.user");case"groups":return a().translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.group");case"clarkwinkelmann-mailing-emails":return a().translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.email")}return"[unknown]"},e.selectResult=function(n){n&&(this.recipients.push(n),this.filter="",this.searchResults=[])},e.content=function(){var n=this;return m(".Modal-body",m("form.Form",{onsubmit:this.onsubmit.bind(this)},[m(".Form-group",[m("label",a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_label")),m(".RecipientsInput.FormControl",{className:this.focused?"focus":""},[m("span.RecipientsInput-selected",this.recipients.map((function(t,e){return m("span.RecipientsInput-recipient",{onclick:function(){n.recipients.splice(e,1)},title:n.searchResultKind(t)},n.recipientLabel(t))}))),m("input.FormControl",{placeholder:a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_placeholder"),value:this.filter,oninput:function(t){n.filter=t.target.value,n.performNewSearch()},onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:function(){n.focused=!0},onblur:function(){n.focused=!1},disabled:this.sending}),this.loadingResults?k().component({size:"small"}):null,this.searchResults.length?m("ul.Dropdown-menu",this.searchResults.map((function(t,e){return m("li",{className:n.searchIndex===e?"active":"",onclick:function(){n.selectResult(t)}},m("button[type=button]",[m("span.SearchResultKind",n.searchResultKind(t)),n.recipientLabel(t)]))}))):null])]),m(".Form-group",[m("label",a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.subject_label")),m("input[type=text].FormControl.js-focus-on-load",{value:this.subject,oninput:function(t){n.subject=t.target.value},placeholder:a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.default_subject"),disabled:this.sending})]),m(".Form-group",[m("label",a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.message_label")),m("textarea.FormControl",{rows:10,value:this.messageText,oninput:function(t){n.messageText=t.target.value},disabled:this.sending})]),m(".Form-group",[o().component({type:"submit",className:"Button Button--primary EditContactModal-save",loading:this.sending,disabled:0===this.recipients.length||""===this.messageText},a().translator.trans("clarkwinkelmann-mailing.forum.modal_mail.submit_button"))])]))},e.performNewSearch=function(){var n=this;this.searchIndex=0;var t=this.filter.toLowerCase();this.buildSearchResults(t),clearTimeout(this.searchTimeout),t.length>=3&&(this.searchTimeout=setTimeout((function(){n.loadingResults=!0,m.redraw(),a().store.find("users",{filter:{q:t},page:{limit:5}}).then((function(){n.loadingResults=!1,n.buildSearchResults(t),m.redraw()}))}),250))},e.buildSearchResults=function(n){var t=this;if(n){var e=[];a().forum.kilowhatMailingCanMailAll()&&a().store.all("groups").forEach((function(t){t.id()!==b().GUEST_ID&&(-1===t.nameSingular().toLowerCase().indexOf(n)&&-1===t.namePlural().toLowerCase().indexOf(n)||e.push(t))})),a().store.all("users").forEach((function(t){-1!==t.username().toLowerCase().indexOf(n)&&e.push(t)})),T.test(this.filter)&&e.push(a().store.createRecord("clarkwinkelmann-mailing-emails",{attributes:{email:this.filter}})),this.searchResults=e.filter((function(n){return n instanceof j?!t.recipients.some((function(t){return t instanceof j&&t.email()===n.email()})):!t.recipients.some((function(t){return t.data.type===n.data.type&&t.id()===n.id()}))})),m.redraw()}else this.searchResults=[]},e.onsubmit=function(n){var t=this;n.preventDefault(),this.sending=!0,a().request({method:"POST",url:a().forum.attribute("apiUrl")+"/admin-mail",body:{data:{recipients:this.recipients.map((function(n){return n instanceof j?{type:n.data.type,attributes:{email:n.email()}}:{type:n.data.type,id:n.id()}})),subject:this.subject,text:this.messageText}}}).then((function(n){a().modal.show(C,{recipientsCount:n.recipientsCount})}),(function(n){t.sending=!1,t.onerror(n)}))},t}(h());const L=flarum.core.compat["common/extenders"];var P=n.n(L);const z=flarum.core.compat["common/models/Forum"];var F=n.n(z);const N=[(new(P().Store)).add("clarkwinkelmann-mailing-emails",j),new(P().Model)(F()).attribute("kilowhatMailingCanMailAll").attribute("kilowhatMailingCanMailIndividual")];a().initializers.add("clarkwinkelmann-mailing",(function(){!function(){(0,i.extend)(s(),"moderationControls",(function(n,t){a().forum.kilowhatMailingCanMailIndividual()&&n.add("clarkwinkelmann-mailing",o().component({icon:"fas fa-envelope",onclick:function(){a().modal.show(O,{user:t})}},a().translator.trans("clarkwinkelmann-mailing.forum.links.mail_individual")))})),(0,i.extend)(u().prototype,"items",(function(n){a().forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",o().component({icon:"fas fa-envelope",onclick:function(){a().modal.show(O,{forAll:!0})}},a().translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")))}));var n=flarum.extensions["fof-user-directory"];n&&n.UserDirectoryPage&&(0,i.extend)(n.UserDirectoryPage.prototype,"actionItems",(function(n){a().forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",o().component({className:"Button",icon:"fas fa-envelope",onclick:function(){a().modal.show(O,{forAll:!0})}},a().translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")),10)}))}()}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map