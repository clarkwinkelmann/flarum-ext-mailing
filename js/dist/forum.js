module.exports=function(n){var t={};function e(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return n[a].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=n,e.c=t,e.d=function(n,t,a){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:a})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var a=Object.create(null);if(e.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(a,i,function(t){return n[t]}.bind(null,i));return a},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=14)}([function(n,t){n.exports=flarum.core.compat.app},function(n,t){n.exports=flarum.core.compat.extend},function(n,t){n.exports=flarum.core.compat.Model},function(n,t){n.exports=flarum.core.compat["components/Button"]},function(n,t){n.exports=flarum.core.compat["components/Modal"]},function(n,t){n.exports=flarum.core.compat["helpers/icon"]},function(n,t){n.exports=flarum.core.compat["models/Forum"]},function(n,t){n.exports=flarum.core.compat["models/Group"]},function(n,t){n.exports=flarum.core.compat["utils/UserControls"]},function(n,t){n.exports=flarum.core.compat["components/SessionDropdown"]},function(n,t){n.exports=flarum.core.compat["components/LoadingIndicator"]},function(n,t){n.exports=flarum.core.compat["helpers/username"]},function(n,t){n.exports=flarum.core.compat["utils/KeyboardNavigatable"]},,function(n,t,e){"use strict";e.r(t);var a=e(0),i=e.n(a),r=e(2),o=e.n(r),l=e(6),s=e.n(l);function u(n){if(void 0===n)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function c(n,t){n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.__proto__=t}function f(n,t,e){return t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e,n}var p=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];return f(u(t=n.call.apply(n,[this].concat(a))||this),"email",o.a.attribute("email")),t}return c(t,n),t}(o.a),d=e(1),h=e(3),g=e.n(h),k=e(8),b=e.n(k),w=e(9),y=e.n(w),v=e(4),x=e.n(v),_=e(10),M=e.n(_),R=e(7),C=e.n(R),j=e(11),I=e.n(j),S=e(5),O=e.n(S),T=e(12),L=e.n(T),N=function(n){function t(){return n.apply(this,arguments)||this}c(t,n);var e=t.prototype;return e.className=function(){return"KilowhatMailingSentModal Modal--small"},e.title=function(){return i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_sent.title_text")},e.content=function(){return[m(".MailingShipping",O()("fas fa-shipping-fast")),m(".Modal-body",[m("h1",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_sent.on_its_way",{recipientsCount:this.attrs.recipientsCount}))])]},t}(x.a),P=/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,z=function(n){function t(){return n.apply(this,arguments)||this}c(t,n);var e=t.prototype;return e.oninit=function(t){var e=this;if(n.prototype.oninit.call(this,t),this.sending=!1,this.recipients=[],this.attrs.user&&this.recipients.push(this.attrs.user),this.attrs.forAll){var a=i.a.store.getById("groups",C.a.MEMBER_ID);this.recipients.push(a)}this.subject="",this.messageText="",this.searchIndex=0,this.navigator=new L.a,this.navigator.when((function(n){return"Tab"!==n.key||!!e.filter})).onUp((function(){e.searchIndex>0&&(e.searchIndex--,m.redraw())})).onDown((function(){e.searchIndex<e.searchResults.length-1&&(e.searchIndex++,m.redraw())})).onSelect((function(){e.selectResult(e.searchResults[e.searchIndex])})).onRemove((function(){e.recipients.pop()})),this.filter="",this.focused=!1,this.loadingResults=!1,this.searchResults=[],this.searchTimeout=null},e.className=function(){return"KilowhatMailingModal Modal--large"},e.title=function(){return i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.title_text")},e.onready=function(){this.$("form").find(".js-focus-on-load").first().focus().select()},e.recipientLabel=function(n){switch(n.data.type){case"users":return m(".RecipientLabel",I()(n));case"groups":return m(".RecipientLabel",n.color()?{className:"colored",style:{backgroundColor:n.color()}}:{},[n.icon()?[O()(n.icon())," "]:null,n.namePlural()]);case"clarkwinkelmann-mailing-emails":return m(".RecipientLabel",n.email())}return"[unknown]"},e.searchResultKind=function(n){switch(n.data.type){case"users":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.user");case"groups":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.group");case"clarkwinkelmann-mailing-emails":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.email")}return"[unknown]"},e.selectResult=function(n){n&&(this.recipients.push(n),this.filter="",this.searchResults=[])},e.content=function(){var n=this;return m(".Modal-body",m("form.Form",{onsubmit:this.onsubmit.bind(this)},[m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_label")),m(".RecipientsInput.FormControl",{className:this.focused?"focus":""},[m("span.RecipientsInput-selected",this.recipients.map((function(t,e){return m("span.RecipientsInput-recipient",{onclick:function(){n.recipients.splice(e,1)},title:n.searchResultKind(t)},n.recipientLabel(t))}))),m("input.FormControl",{placeholder:i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_placeholder"),value:this.filter,oninput:function(t){n.filter=t.target.value,n.performNewSearch()},onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:function(){n.focused=!0},onblur:function(){n.focused=!1},disabled:this.sending}),this.loadingResults?M.a.component({size:"tiny",className:"Button Button--icon Button--link"}):null,this.searchResults.length?m("ul.Dropdown-menu",this.searchResults.map((function(t,e){return m("li",{className:n.searchIndex===e?"active":"",onclick:function(){n.selectResult(t)}},m("button[type=button]",[m("span.SearchResultKind",n.searchResultKind(t)),n.recipientLabel(t)]))}))):null])]),m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.subject_label")),m("input[type=text].FormControl.js-focus-on-load",{value:this.subject,oninput:function(t){n.subject=t.target.value},placeholder:i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.default_subject"),disabled:this.sending})]),m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.message_label")),m("textarea.FormControl",{rows:10,value:this.messageText,oninput:function(t){n.messageText=t.target.value},disabled:this.sending})]),m(".Form-group",[g.a.component({type:"submit",className:"Button Button--primary EditContactModal-save",loading:this.sending,disabled:0===this.recipients.length||""===this.messageText},i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.submit_button"))])]))},e.performNewSearch=function(){var n=this;this.searchIndex=0;var t=this.filter.toLowerCase();this.buildSearchResults(t),clearTimeout(this.searchTimeout),t.length>=3&&(this.searchTimeout=setTimeout((function(){n.loadingResults=!0,m.redraw(),i.a.store.find("users",{filter:{q:t},page:{limit:5}}).then((function(){n.loadingResults=!1,n.buildSearchResults(t),m.redraw()}))}),250))},e.buildSearchResults=function(n){var t=this;if(n){var e=[];i.a.forum.kilowhatMailingCanMailAll()&&i.a.store.all("groups").forEach((function(t){t.id()!==C.a.GUEST_ID&&(-1===t.nameSingular().toLowerCase().indexOf(n)&&-1===t.namePlural().toLowerCase().indexOf(n)||e.push(t))})),i.a.store.all("users").forEach((function(t){-1!==t.username().toLowerCase().indexOf(n)&&e.push(t)})),P.test(this.filter)&&e.push(i.a.store.createRecord("clarkwinkelmann-mailing-emails",{attributes:{email:this.filter}})),this.searchResults=e.filter((function(n){return"clarkwinkelmann-mailing-emails"===n.data.type?!t.recipients.some((function(t){return"clarkwinkelmann-mailing-emails"===t.data.type&&t.email()===n.email()})):!t.recipients.some((function(t){return t.data.type===n.data.type&&t.id()===n.id()}))})),m.redraw()}else this.searchResults=[]},e.onsubmit=function(n){var t=this;n.preventDefault(),this.sending=!0,i.a.request({method:"POST",url:i.a.forum.attribute("apiUrl")+"/admin-mail",body:{data:{recipients:this.recipients.map((function(n){return"clarkwinkelmann-mailing-emails"===n.data.type?{type:n.data.type,attributes:{email:n.email()}}:{type:n.data.type,id:n.id()}})),subject:this.subject,text:this.messageText}}}).then((function(n){t.hide(),i.a.modal.show(N,{recipientsCount:n.recipientsCount})}),(function(n){t.sending=!1,t.onerror(n)}))},t}(x.a);i.a.initializers.add("clarkwinkelmann-mailing",(function(){i.a.store.models["clarkwinkelmann-mailing-emails"]=p,s.a.prototype.kilowhatMailingCanMailAll=o.a.attribute("kilowhatMailingCanMailAll"),s.a.prototype.kilowhatMailingCanMailIndividual=o.a.attribute("kilowhatMailingCanMailIndividual"),function(){Object(d.extend)(b.a,"moderationControls",(function(n,t){i.a.forum.kilowhatMailingCanMailIndividual()&&n.add("clarkwinkelmann-mailing",g.a.component({icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{user:t})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_individual")))})),Object(d.extend)(y.a.prototype,"items",(function(n){i.a.forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",g.a.component({icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{forAll:!0})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")))}));var n=flarum.extensions["fof-user-directory"];n&&n.UserDirectoryPage&&Object(d.extend)(n.UserDirectoryPage.prototype,"actionItems",(function(n){i.a.forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",g.a.component({className:"Button",icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{forAll:!0})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")),10)}))}()}))}]);
//# sourceMappingURL=forum.js.map