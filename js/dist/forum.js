module.exports=function(n){var t={};function e(a){if(t[a])return t[a].exports;var i=t[a]={i:a,l:!1,exports:{}};return n[a].call(i.exports,i,i.exports,e),i.l=!0,i.exports}return e.m=n,e.c=t,e.d=function(n,t,a){e.o(n,t)||Object.defineProperty(n,t,{enumerable:!0,get:a})},e.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},e.t=function(n,t){if(1&t&&(n=e(n)),8&t)return n;if(4&t&&"object"==typeof n&&n&&n.__esModule)return n;var a=Object.create(null);if(e.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:n}),2&t&&"string"!=typeof n)for(var i in n)e.d(a,i,function(t){return n[t]}.bind(null,i));return a},e.n=function(n){var t=n&&n.__esModule?function(){return n.default}:function(){return n};return e.d(t,"a",t),t},e.o=function(n,t){return Object.prototype.hasOwnProperty.call(n,t)},e.p="",e(e.s=14)}([function(n,t){n.exports=flarum.core.compat["forum/app"]},function(n,t){n.exports=flarum.core.compat["common/Model"]},function(n,t){n.exports=flarum.core.compat["common/components/Button"]},,function(n,t){n.exports=flarum.core.compat["common/components/Modal"]},function(n,t){n.exports=flarum.core.compat["common/helpers/icon"]},function(n,t){n.exports=flarum.core.compat["common/extend"]},function(n,t){n.exports=flarum.core.compat["common/models/Forum"]},function(n,t){n.exports=flarum.core.compat["common/models/Group"]},function(n,t){n.exports=flarum.core.compat["forum/utils/UserControls"]},function(n,t){n.exports=flarum.core.compat["forum/components/SessionDropdown"]},function(n,t){n.exports=flarum.core.compat["common/components/LoadingIndicator"]},function(n,t){n.exports=flarum.core.compat["common/helpers/username"]},function(n,t){n.exports=flarum.core.compat["common/utils/KeyboardNavigatable"]},function(n,t,e){"use strict";e.r(t);var a=e(0),i=e.n(a),r=e(1),o=e.n(r),l=e(7),s=e.n(l);function c(n,t){return(c=Object.setPrototypeOf||function(n,t){return n.__proto__=t,n})(n,t)}function u(n,t){n.prototype=Object.create(t.prototype),n.prototype.constructor=n,c(n,t)}var f=function(n){function t(){for(var t,e=arguments.length,a=new Array(e),i=0;i<e;i++)a[i]=arguments[i];return(t=n.call.apply(n,[this].concat(a))||this).email=o.a.attribute("email"),t}return u(t,n),t}(o.a),p=e(6),d=e(2),h=e.n(d),g=e(9),k=e.n(g),b=e(10),w=e.n(b),y=e(4),v=e.n(y),x=e(11),_=e.n(x),M=e(8),R=e.n(M),C=e(12),j=e.n(C),I=e(5),S=e.n(I),O=e(13),T=e.n(O),L=function(n){function t(){return n.apply(this,arguments)||this}u(t,n);var e=t.prototype;return e.className=function(){return"KilowhatMailingSentModal Modal--small"},e.title=function(){return i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_sent.title_text")},e.content=function(){return[m(".MailingShipping",S()("fas fa-shipping-fast")),m(".Modal-body",[m("h1",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_sent.on_its_way",{recipientsCount:this.attrs.recipientsCount}))])]},t}(v.a),P=/^[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?$/i,z=function(n){function t(){return n.apply(this,arguments)||this}u(t,n);var e=t.prototype;return e.oninit=function(t){var e=this;if(n.prototype.oninit.call(this,t),this.sending=!1,this.recipients=[],this.attrs.user&&this.recipients.push(this.attrs.user),this.attrs.forAll){var a=i.a.store.getById("groups",R.a.MEMBER_ID);this.recipients.push(a)}this.subject="",this.messageText="",this.searchIndex=0,this.navigator=new T.a,this.navigator.when((function(n){return"Tab"!==n.key||!!e.filter})).onUp((function(){e.searchIndex>0&&(e.searchIndex--,m.redraw())})).onDown((function(){e.searchIndex<e.searchResults.length-1&&(e.searchIndex++,m.redraw())})).onSelect((function(){e.selectResult(e.searchResults[e.searchIndex])})).onRemove((function(){e.recipients.pop()})),this.filter="",this.focused=!1,this.loadingResults=!1,this.searchResults=[],this.searchTimeout=null},e.className=function(){return"KilowhatMailingModal Modal--large"},e.title=function(){return i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.title_text")},e.onready=function(){this.$("form").find(".js-focus-on-load").first().focus().select()},e.recipientLabel=function(n){switch(n.data.type){case"users":return m(".RecipientLabel",j()(n));case"groups":return m(".RecipientLabel",n.color()?{className:"colored",style:{backgroundColor:n.color()}}:{},[n.icon()?[S()(n.icon())," "]:null,n.namePlural()]);case"clarkwinkelmann-mailing-emails":return m(".RecipientLabel",n.email())}return"[unknown]"},e.searchResultKind=function(n){switch(n.data.type){case"users":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.user");case"groups":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.group");case"clarkwinkelmann-mailing-emails":return i.a.translator.trans("clarkwinkelmann-mailing.forum.recipient_kinds.email")}return"[unknown]"},e.selectResult=function(n){n&&(this.recipients.push(n),this.filter="",this.searchResults=[])},e.content=function(){var n=this;return m(".Modal-body",m("form.Form",{onsubmit:this.onsubmit.bind(this)},[m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_label")),m(".RecipientsInput.FormControl",{className:this.focused?"focus":""},[m("span.RecipientsInput-selected",this.recipients.map((function(t,e){return m("span.RecipientsInput-recipient",{onclick:function(){n.recipients.splice(e,1)},title:n.searchResultKind(t)},n.recipientLabel(t))}))),m("input.FormControl",{placeholder:i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.recipients_placeholder"),value:this.filter,oninput:function(t){n.filter=t.target.value,n.performNewSearch()},onkeydown:this.navigator.navigate.bind(this.navigator),onfocus:function(){n.focused=!0},onblur:function(){n.focused=!1},disabled:this.sending}),this.loadingResults?_.a.component({size:"small"}):null,this.searchResults.length?m("ul.Dropdown-menu",this.searchResults.map((function(t,e){return m("li",{className:n.searchIndex===e?"active":"",onclick:function(){n.selectResult(t)}},m("button[type=button]",[m("span.SearchResultKind",n.searchResultKind(t)),n.recipientLabel(t)]))}))):null])]),m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.subject_label")),m("input[type=text].FormControl.js-focus-on-load",{value:this.subject,oninput:function(t){n.subject=t.target.value},placeholder:i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.default_subject"),disabled:this.sending})]),m(".Form-group",[m("label",i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.message_label")),m("textarea.FormControl",{rows:10,value:this.messageText,oninput:function(t){n.messageText=t.target.value},disabled:this.sending})]),m(".Form-group",[h.a.component({type:"submit",className:"Button Button--primary EditContactModal-save",loading:this.sending,disabled:0===this.recipients.length||""===this.messageText},i.a.translator.trans("clarkwinkelmann-mailing.forum.modal_mail.submit_button"))])]))},e.performNewSearch=function(){var n=this;this.searchIndex=0;var t=this.filter.toLowerCase();this.buildSearchResults(t),clearTimeout(this.searchTimeout),t.length>=3&&(this.searchTimeout=setTimeout((function(){n.loadingResults=!0,m.redraw(),i.a.store.find("users",{filter:{q:t},page:{limit:5}}).then((function(){n.loadingResults=!1,n.buildSearchResults(t),m.redraw()}))}),250))},e.buildSearchResults=function(n){var t=this;if(n){var e=[];i.a.forum.kilowhatMailingCanMailAll()&&i.a.store.all("groups").forEach((function(t){t.id()!==R.a.GUEST_ID&&(-1===t.nameSingular().toLowerCase().indexOf(n)&&-1===t.namePlural().toLowerCase().indexOf(n)||e.push(t))})),i.a.store.all("users").forEach((function(t){-1!==t.username().toLowerCase().indexOf(n)&&e.push(t)})),P.test(this.filter)&&e.push(i.a.store.createRecord("clarkwinkelmann-mailing-emails",{attributes:{email:this.filter}})),this.searchResults=e.filter((function(n){return"clarkwinkelmann-mailing-emails"===n.data.type?!t.recipients.some((function(t){return"clarkwinkelmann-mailing-emails"===t.data.type&&t.email()===n.email()})):!t.recipients.some((function(t){return t.data.type===n.data.type&&t.id()===n.id()}))})),m.redraw()}else this.searchResults=[]},e.onsubmit=function(n){var t=this;n.preventDefault(),this.sending=!0,i.a.request({method:"POST",url:i.a.forum.attribute("apiUrl")+"/admin-mail",body:{data:{recipients:this.recipients.map((function(n){return"clarkwinkelmann-mailing-emails"===n.data.type?{type:n.data.type,attributes:{email:n.email()}}:{type:n.data.type,id:n.id()}})),subject:this.subject,text:this.messageText}}}).then((function(n){t.hide(),i.a.modal.show(L,{recipientsCount:n.recipientsCount})}),(function(n){t.sending=!1,t.onerror(n)}))},t}(v.a);i.a.initializers.add("clarkwinkelmann-mailing",(function(){i.a.store.models["clarkwinkelmann-mailing-emails"]=f,s.a.prototype.kilowhatMailingCanMailAll=o.a.attribute("kilowhatMailingCanMailAll"),s.a.prototype.kilowhatMailingCanMailIndividual=o.a.attribute("kilowhatMailingCanMailIndividual"),function(){Object(p.extend)(k.a,"moderationControls",(function(n,t){i.a.forum.kilowhatMailingCanMailIndividual()&&n.add("clarkwinkelmann-mailing",h.a.component({icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{user:t})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_individual")))})),Object(p.extend)(w.a.prototype,"items",(function(n){i.a.forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",h.a.component({icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{forAll:!0})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")))}));var n=flarum.extensions["fof-user-directory"];n&&n.UserDirectoryPage&&Object(p.extend)(n.UserDirectoryPage.prototype,"actionItems",(function(n){i.a.forum.kilowhatMailingCanMailAll()&&n.add("clarkwinkelmann-mailing",h.a.component({className:"Button",icon:"fas fa-envelope",onclick:function(){i.a.modal.show(z,{forAll:!0})}},i.a.translator.trans("clarkwinkelmann-mailing.forum.links.mail_all")),10)}))}()}))}]);
//# sourceMappingURL=forum.js.map